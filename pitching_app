library(shiny)
library(dplyr)
library(DT)
library(ggplot2)
library(gt)
library(scales)
library(shinyWidgets)
library(tidyverse)
library(readr)
library(pitchRx)
library(cowplot)
library(gtsummary)
library(ggrepel)
library(lubridate)
library(caret)
library(caTools)
library(randomForest)
library(Metrics)
library(viridis)
library(plotly)



Game_File <- read.csv("yourdatahere.csv")


#Import randomForest Models for l/r + fb/offspeed (found in my github as well
r_fb_model <- readRDS("r_fb.rds")
r_os_model <- readRDS("r_os.rds")
l_fb_model <- readRDS("l_fb.rds")
l_os_model <- readRDS("l_os.rds")


#Import all theoretical predictions for movement based on averages of other points
r_fb_all_predictions <- read.csv('r_fb_all_predictions.csv')
r_os_all_predictions <- read.csv('r_os_all_predictions.csv')
l_fb_all_predictions <- read.csv('l_fb_all_predictions.csv')
l_os_all_predictions <- read.csv('l_os_all_predictions.csv')


#Filter data to only include players you want
Game_File$PitcherTeam <- (ifelse(
  (Game_File$Pitcher %in% c('lastname, firstname')),
  'GEO_PAT',
  'NOT_GMU'
))

Game_File$BatterTeam <- (ifelse(
  (Game_File$Batter %in% c('lastname, firstname')),
  'GEO_PAT',
  'NOT_GMU'
))


Game_File <- Game_File %>% 
  filter(PitcherTeam == "GMU_PAT" | PitcherTeam == "GEO_PAT") %>% 
  mutate(RelHeight = substr(RelHeight, 1, nchar(RelHeight)), 
         RelHeight = as.double(RelHeight),
         Balls = substr(Balls, 1, nchar(Balls)), 
         Balls = as.double(Balls),
         Strikes = substr(Strikes, 1, nchar(Strikes)), 
         Strikes = as.double(Strikes))
BACON <- read.csv("xwOBAcon.csv")
umpire_data <- read_csv("called_strike.csv")

Game_File$Count <- paste(Game_File$Balls, Game_File$Strikes, sep = "-")

# Checks and CSV adjustments
ChecksCSV <- Game_File %>%
  mutate(HCheck = case_when(PlayResult %in% c('Single', 'Double', 'Triple', 'HomeRun') ~ TRUE, TRUE ~ FALSE),
         GBCheck = case_when(TaggedHitType %in% c('GroundBall') ~ TRUE, TRUE ~ FALSE),
         BBECheck = case_when(TaggedHitType %in% c('GroundBall', 'LineDrive', 'FlyBall', 'Popup') ~ TRUE, TRUE ~ FALSE), 
         SwingCheck = case_when(PitchCall %in% c('FoulBall', 'StrikeSwinging','InPlay') ~ TRUE, TRUE ~ FALSE),
         WhiffCheck = case_when(PitchCall %in% c('StrikeSwinging') ~ TRUE, TRUE ~ FALSE),
         CSWCheck = case_when(PitchCall %in% c('StrikeSwinging','StrikeCalled') ~ TRUE, TRUE ~ FALSE),
         StrikeCheck = case_when(PitchCall %in% c('StrikeSwinging', 'FoulBall', 'InPlay','StrikeCalled') ~ TRUE, TRUE ~ FALSE),
         ZoneCheck = case_when(between(PlateLocHeight, 1.59, 3.41) & between(PlateLocSide, -1, 1) ~ TRUE, TRUE ~ FALSE),
         SweetSpotCheck = case_when(between(Angle, 10, 30) ~ TRUE, TRUE ~ FALSE),
         HardHitCheck = case_when(between(ExitSpeed, 95, 120) ~ TRUE, TRUE ~ FALSE),
         BarrelCheck = case_when(between(Angle, 10, 30)  & between(ExitSpeed, 95, 120) ~ TRUE, TRUE ~ FALSE),
         WhiffCheck = case_when(PitchCall %in% c('StrikeSwinging') ~ TRUE, TRUE ~ FALSE),
         SwingCheck = case_when(PitchCall %in% c('StrikeSwinging', 'InPlay','FoulBall') ~ TRUE, TRUE ~ FALSE),
         CalledStrikeCheck = case_when(PitchCall %in% c('StrikeCalled') ~ TRUE, TRUE ~ FALSE),
         BallCheck = case_when(PitchCall %in% c('BallCalled', 'HitByPitch') ~ TRUE, TRUE ~ FALSE),
         FoulCheck = case_when(PitchCall %in% c('FoulBall') ~ TRUE, TRUE ~ FALSE),
         SingleCheck = case_when(PlayResult %in% c('Single') ~ TRUE, TRUE ~ FALSE),
         DoubleCheck = case_when(PlayResult %in% c('Double') ~ TRUE, TRUE ~ FALSE),
         TripleCheck = case_when(PlayResult %in% c('Triple') ~ TRUE, TRUE ~ FALSE),
         HRCheck = case_when(PlayResult %in% c('HomeRun') ~ TRUE, TRUE ~ FALSE),
         SacCheck = case_when(PlayResult %in% c('Sacrifice') ~ TRUE, TRUE ~ FALSE),
         HBPCheck = case_when(PitchCall %in% c('HitByPitch') ~ TRUE, TRUE ~ FALSE),
         StrikeoutCheck = case_when(KorBB %in% c('Strikeout') ~ TRUE, TRUE ~ FALSE),
         WalkCheck = case_when(KorBB %in% c('Walk') ~ TRUE, TRUE ~ FALSE),
         BIPCheck = case_when(PlayResult %in% c('Undefined') ~ FALSE, TRUE ~ TRUE), 
         ErrorCheck = if_else(PlayResult %in% c('Error'), TRUE, FALSE),
         ABCheck = StrikeoutCheck + BIPCheck - SacCheck,
         PACheck = StrikeoutCheck + WalkCheck + HBPCheck + BIPCheck)

#Other file uploads for expected stats
BACONCSV <- ChecksCSV %>% 
  mutate(floorExitSpeed = floor(ExitSpeed),
         floorLaunchAngle = trunc(Angle),) %>% 
  left_join(BACON, by = c("floorExitSpeed" = "launch_speed", 
                          "floorLaunchAngle" = "launch_angle"))

strike_exp_data <- BACONCSV %>%  
  mutate(RoundedPLH = round(PlateLocHeight, digits = 1),
         RoundedPLS = round(PlateLocSide, digits = 1)) %>% 
  left_join(umpire_data, by = c("RoundedPLH" = "PlateLocHeight",
                                "RoundedPLS" = "PlateLocSide"))

strike_exp_diff <- strike_exp_data %>% 
  mutate(strike_exp_diff = abs(StrikeCheck - called_strike_prob))


#Other data frame adjustments
FinalCSV <- strike_exp_diff %>%
  mutate(across("av_xwOBAcon", ~replace_na(., 0)),
         across("strike_exp_diff", ~replace_na(., 0)),
         xwOBAvalues = av_xwOBAcon + WalkCheck * 0.83 + HBPCheck * 0.86 + StrikeoutCheck * 0)

FinalCSV$Date <- parse_date_time(FinalCSV$Date, orders = c('ymd', '%m/%d/%Y'))

FinalCSV$Date <- as.Date(FinalCSV$Date, "%Y-%m-%d")

FinalCSV$GameType <- ifelse(FinalCSV$Batter == "", "Bullpen", "Intersquad")

FinalCSV$CallType <- ifelse(strike_exp_diff$StrikeCheck & !strike_exp_diff$ZoneCheck 
                            | !strike_exp_diff$StrikeCheck & strike_exp_diff$ZoneCheck, "Incorrect", "Correct")


# Add PitchGroup Variable with handling for NA values
FinalCSV$PitchGroup <- (ifelse(
  (FinalCSV$TaggedPitchType %in% c('Fastball', 'Four-Seam', 'Sinker', 'Cutter', 'FourSeamFastBall') & !is.na(FinalCSV$TaggedPitchType)),
  'FB',
  ifelse(
    (FinalCSV$TaggedPitchType %in% c('Curveball', 'Slider', 'Sweeper', 'ChangeUp', 'Splitter', 'Forkball') & !is.na(FinalCSV$TaggedPitchType)),
    'OS',
    'NA'
  )))


#Omit all rows that do not have all values in our important variables
FinalCSV <- FinalCSV %>%  filter(PitchGroup != 'NA')
FinalCSV <- FinalCSV %>%  filter(BatterSide != 'Undefined')
FinalCSV <- FinalCSV %>%  filter(PitcherThrows != 'Undefined')
FinalCSV <- FinalCSV %>%  filter(!is.na(RelSpeed))
FinalCSV <- FinalCSV %>%  filter(!is.na(InducedVertBreak))
FinalCSV <- FinalCSV %>%  filter(!is.na(HorzBreak))
FinalCSV <- FinalCSV %>%  filter(!is.na(VertRelAngle))
FinalCSV <- FinalCSV %>%  filter(!is.na(HorzRelAngle))
FinalCSV <- FinalCSV %>%  filter(!is.na(SpinRate))
FinalCSV <- FinalCSV %>%  filter(!is.na(SpinAxis))
FinalCSV <- FinalCSV %>%  filter(!is.na(RelHeight))
FinalCSV <- FinalCSV %>%  filter(!is.na(RelSide))
FinalCSV <- FinalCSV %>%  filter(!is.na(Extension))


#Create new data frame that increases every pitch speed by 2 to predict possible Stuff+ performance with +2 mph
FinalCSV_plus_two <- FinalCSV
FinalCSV_plus_two$RelSpeed <- FinalCSV_plus_two$RelSpeed + 2


#Create two dataframes from which to predict each pitch's value
predict_frame <- FinalCSV[c('RelSpeed', 'SpinRate', 'InducedVertBreak', 'HorzBreak', 'RelHeight', 'RelSide', 'Extension')]
predict_frame_2 <- FinalCSV_plus_two[c('RelSpeed', 'SpinRate', 'InducedVertBreak', 'HorzBreak', 'RelHeight', 'RelSide', 'Extension')]


# Make the first prediction
FinalCSV$Predict <- ifelse(
  FinalCSV$PitchGroup == 'FB' & FinalCSV$PitcherThrows == 'Right',
  predict(r_fb_model, newdata = predict_frame, type= "class"),
  ifelse(
    FinalCSV$PitchGroup == 'OS' & FinalCSV$PitcherThrows == 'Right',
    predict(r_os_model, newdata = predict_frame, type= "class"),
    ifelse(
      FinalCSV$PitchGroup == 'FB' & FinalCSV$PitcherThrows == 'Left',
      predict(l_fb_model, newdata = predict_frame, type= "class"),
      ifelse(
        FinalCSV$PitchGroup == 'OS' & FinalCSV$PitcherThrows == 'Left',
        predict(l_os_model, newdata = predict_frame, type= "class"),
        0
      )
    )
  )
)



# Make the second prediction with RelSpeed increased by 2
# Replace 'RelSpeed' with 'RelSpeed_tmp' in the model's newdata argument
FinalCSV_plus_two$Predict <- ifelse(
  FinalCSV$PitchGroup == 'FB' & FinalCSV$PitcherThrows == 'Right',
  predict(r_fb_model, newdata = predict_frame_2, type= "class"),
  ifelse(
    FinalCSV$PitchGroup == 'OS' & FinalCSV$PitcherThrows == 'Right',
    predict(r_os_model, newdata = predict_frame_2, type= "class"),
    ifelse(
      FinalCSV$PitchGroup == 'FB' & FinalCSV$PitcherThrows == 'Left',
      predict(l_fb_model, newdata = predict_frame_2, type= "class"),
      ifelse(
        FinalCSV$PitchGroup == 'OS' & FinalCSV$PitcherThrows == 'Left',
        predict(l_os_model, newdata = predict_frame_2, type= "class"),
        0
      )
    )
  )
)



#Edit Stuff variables
FinalCSV$Stuff_plus <- FinalCSV$Predict
head(FinalCSV)

FinalCSV$Stuff_plus <- FinalCSV$Stuff_plus * (-1)
head(FinalCSV)

FinalCSV <- FinalCSV %>%
  mutate_at(vars(Stuff_plus), function(x) scale(x)*50 + 100)

FinalCSV$PitchCount <- 0
for (i in 1:nrow(FinalCSV)) {FinalCSV$PitchCount[i] <- sum(FinalCSV$Pitcher[1:i] == FinalCSV$Pitcher[i])}



#Edit Stuff variables in +2 data frame
FinalCSV_plus_two$Stuff_plus <- FinalCSV_plus_two$Predict
head(FinalCSV_plus_two)

FinalCSV_plus_two$Stuff_plus <- FinalCSV_plus_two$Stuff_plus * (-1)
head(FinalCSV_plus_two)

FinalCSV_plus_two <- FinalCSV_plus_two %>%
  mutate_at(vars(Stuff_plus), function(x) scale(x)*50 + 100)

FinalCSV_plus_two$PitchCount <- 0
for (i in 1:nrow(FinalCSV_plus_two)) {FinalCSV_plus_two$PitchCount[i] <- sum(FinalCSV_plus_two$Pitcher[1:i] == FinalCSV_plus_two$Pitcher[i])}






# ui
{ui <- fluidPage(
  
  titlePanel("Pitching Data"),
  br(),
  sidebarLayout(
    sidebarPanel(
      selectInput(inputId = "PitcherInput", label = "Select Pitcher", 
                  choices = c(All = "All", sort(unique(FinalCSV$Pitcher)))),
      dateRangeInput(inputId = "DateRangeInput", label = "Select Date Range", 
                     start = min(FinalCSV$Date), end = max(FinalCSV$Date)),
      img(src = "https://upload.wikimedia.org/wikipedia/commons/thumb/c/c0/George_Mason_baseball_logo.svg/1280px-George_Mason_baseball_logo.svg.png", 
          style = "display: block; margin-left: auto; margin-right: auto;", height = 150, width = 150)),
    mainPanel(
      tabsetPanel(
        tabPanel("Metrics/Results", br(), 
                 dataTableOutput("summary_table"), 
                 dataTableOutput("pitcher_summary_table"), 
                 dataTableOutput("pitcher_results_table"),
                 dataTableOutput("pitcher_splits_table")),
        tabPanel("Results By Split", br(), 
                 dataTableOutput("pitcher_count_results"),
                 dataTableOutput("pitch_type_table")),
        tabPanel("Heat Maps", br(), plotOutput("plot1")),
        tabPanel("Movement/Release", br(), 
                 plotOutput("pitch_movement_plot"),
                 plotOutput("pitch_release_plot")),
        tabPanel("Locations", br(), 
                 plotOutput("pitch_location_plot1"),
                 plotOutput("pitch_location_plot2"),
                 plotOutput("pitch_location_plot3")),
        tabPanel("Game Progression", br(),
                 plotOutput("lineplot5"),
                 plotOutput("lineplot2"),
                 plotOutput("lineplot1"), 
                 plotOutput("lineplot3"), 
                 plotOutput("lineplot4")),
        tabPanel("Stuff+", br(), 
                 dataTableOutput("pitcher_summary_table_1"),
                 plotOutput("r_fb_stuff_plot"),
                 plotOutput("r_os_stuff_plot"),
                 plotOutput("l_fb_stuff_plot"),
                 plotOutput("l_os_stuff_plot"),
                 dataTableOutput("pitcher_summary_table_plus_2")),
      )
    )
  )
)
}  

server <- function(input, output, session) {
  
  observeEvent(input$PitcherInput, 
               updateSelectInput(session, inputId = "GameInput", label = "Select Game/Date:", 
                                 choices = sort(unique(FinalCSV$Date[FinalCSV$Pitcher == input$PitcherInput]))))
  
  output$selected_pitcher <- renderText({paste(input$PitcherInput)})
  
  output$selected_game <- renderText({paste(input$DateRangeInput)})
  
  output$summary_table <- renderDataTable({
    table <- FinalCSV
    
    if(input$PitcherInput != "All") {
      table <- table %>% filter(Pitcher %in% input$PitcherInput)
    }
    table <- table %>%
      filter(between(Date, input$DateRangeInput[1], input$DateRangeInput[2])) %>%
      summarize('Pitches' = n(),
                PA = sum(PACheck, na.rm = TRUE), 
                BBE = sum(BBECheck, na.rm = TRUE),
                H = sum(HCheck, na.rm = TRUE), 
                `1B` = sum(SingleCheck, na.rm = TRUE), 
                `2B` = sum(DoubleCheck, na.rm = TRUE), 
                `3B` = sum(TripleCheck, na.rm = TRUE), 
                HR = sum(HRCheck, na.rm = TRUE), 
                SO = sum(StrikeoutCheck, na.rm = TRUE), 
                BB = sum(WalkCheck, na.rm = TRUE), 
                HBP = sum(HBPCheck, na.rm = TRUE),
                Strikes = sum(StrikeCheck, na.rm = TRUE), 
                Chases = sum(SwingCheck[ZoneCheck == FALSE], na.rm = TRUE), 
                Whiffs = sum(WhiffCheck[SwingCheck == TRUE], na.rm = TRUE))
    
    table[is.na(table)] <- "-"
    
    tableFilter <- reactive({table})
    datatable(tableFilter(), options = list(dom = 't', columnDefs = list(list(targets = 0, visible = FALSE))))
  })
  
  output$pitcher_summary_table <- renderDataTable({
    table <- FinalCSV
    
    if(input$PitcherInput != "All") {
      table <- table %>% filter(Pitcher %in% input$PitcherInput)
    }
    table <- table %>%
      filter(between(Date, input$DateRangeInput[1], input$DateRangeInput[2])) %>%
      group_by('Pitch' = TaggedPitchType) %>%
      summarize('Pitches' = n(), 
                'Stuff' = round(median(Stuff_plus, na.rm = TRUE), 0), 
                'AvgVelo' = round(median(RelSpeed, na.rm = TRUE), 1),
                'MaxVelo' = round(max(RelSpeed, na.rm = TRUE), 1),
                'SpinRate' = round(median(SpinRate, na.rm = TRUE), 0),
                'IVB' = round(median(InducedVertBreak, na.rm = TRUE), 1),
                'HB' = round(median(HorzBreak, na.rm = TRUE), 1),
                'RelZ' = round(median(RelHeight, na.rm = TRUE), 1),
                'RelX' = round(median(RelSide, na.rm = TRUE), 1),
                'Ext' = round(median(Extension, na.rm = TRUE), 1)) %>% 
      mutate(Usage = Pitches / sum(Pitches)) %>% 
      mutate(Usage = scales::percent(Usage, accuracy = 0.1)) %>%
      select(Pitch, Pitches, Stuff, Usage, AvgVelo, MaxVelo, SpinRate, IVB, HB, RelZ, RelX, Ext)
    
    table[is.na(table)] = 0  
    
    tableFilter <- reactive({table})
    datatable(tableFilter(), options = list(dom = 't', columnDefs = list(list(targets = 0, visible = FALSE))))
  })
  
  output$pitcher_summary_table_1 <- renderDataTable({
    table <- FinalCSV
    
    if(input$PitcherInput != "All") {
      table <- table %>% filter(Pitcher %in% input$PitcherInput)
    }
    table <- table %>%
      filter(between(Date, input$DateRangeInput[1], input$DateRangeInput[2])) %>%
      group_by('Pitch' = TaggedPitchType) %>%
      summarize('Pitches' = n(), 
                'Stuff' = round(median(Stuff_plus, na.rm = TRUE), 0), 
                'AvgVelo' = round(median(RelSpeed, na.rm = TRUE), 1),
                'MaxVelo' = round(max(RelSpeed, na.rm = TRUE), 1),
                'SpinRate' = round(median(SpinRate, na.rm = TRUE), 0),
                'IVB' = round(median(InducedVertBreak, na.rm = TRUE), 1),
                'HB' = round(median(HorzBreak, na.rm = TRUE), 1),
                'RelZ' = round(median(RelHeight, na.rm = TRUE), 1),
                'RelX' = round(median(RelSide, na.rm = TRUE), 1),
                'Ext' = round(median(Extension, na.rm = TRUE), 1)) %>% 
      mutate(Usage = Pitches / sum(Pitches)) %>% 
      mutate(Usage = scales::percent(Usage, accuracy = 0.1)) %>%
      select(Pitch, Pitches, Stuff, Usage, AvgVelo, MaxVelo, SpinRate, IVB, HB, RelZ, RelX, Ext)
    
    table[is.na(table)] = 0  
    
    tableFilter <- reactive({table})
    datatable(tableFilter(), options = list(dom = 't', columnDefs = list(list(targets = 0, visible = FALSE))))
  })
  
  
  output$pitcher_results_table <- renderDataTable({
    table <- FinalCSV
    
    if(input$PitcherInput != "All") {
      table <- table %>% filter(Pitcher %in% input$PitcherInput)
    }
    
    table <- table %>%
      filter(between(Date, input$DateRangeInput[1], input$DateRangeInput[2])) %>%   
      group_by('Pitch' = TaggedPitchType) %>%
      summarize('Pitches' = n(),
                PA = sum(PACheck, na.rm = TRUE), 
                AB = sum(ABCheck, na.rm = TRUE), 
                H = sum(HCheck, na.rm = TRUE), 
                `1B` = sum(SingleCheck, na.rm = TRUE), 
                `2B` = sum(DoubleCheck, na.rm = TRUE), 
                `3B` = sum(TripleCheck, na.rm = TRUE), 
                HR = sum(HRCheck, na.rm = TRUE), 
                TB = (`1B`) + (`2B` * 2) + (`3B` * 3) + (HR * 4),
                SO = sum(StrikeoutCheck, na.rm = TRUE), 
                BB = sum(WalkCheck, na.rm = TRUE), 
                HBP = sum(HBPCheck, na.rm = TRUE),
                xwOBA = round(mean(xwOBAvalues[PACheck == TRUE], na.rm = TRUE), 3),
                `CSW%` = mean(CSWCheck, na.rm = TRUE), 
                `Strike%` = mean(StrikeCheck, na.rm = TRUE), 
                `StrikeProb%` = mean(called_strike_prob, na.rm = TRUE),
                `Zone%` = mean(ZoneCheck, na.rm = TRUE), 
                `Swing%` = mean(SwingCheck, na.rm = TRUE), 
                `Chase%` = mean(SwingCheck[ZoneCheck == FALSE], na.rm = TRUE), 
                `Z-Whiff%` = mean(WhiffCheck[ZoneCheck == TRUE & SwingCheck == TRUE]),
                `Whiff%` = mean(WhiffCheck[SwingCheck == TRUE], na.rm = TRUE), 
                `Z-Swing%` = mean(SwingCheck[ZoneCheck == TRUE], na.rm = TRUE),
                BBE = sum(BBECheck, na.rm = TRUE),
                xDamage = mean(av_xwOBAcon[BBECheck == TRUE],  na.rm = TRUE),
                AvgEV = mean(ExitSpeed[BBECheck == TRUE], na.rm = TRUE), 
                AVG = H / AB,
                OBP = (H + BB + HBP) / PA,
                SLG = TB / AB) %>% 
      mutate(`CSW%` = scales::percent(`CSW%`, accuracy = 0.1),
             `Strike%` = scales::percent(`Strike%`, accuracy = 0.1),
             `StrikeProb%` = scales::percent(`StrikeProb%`, accuracy = 0.1),
             `Zone%` = scales::percent(`Zone%`, accuracy = 0.1),
             `Chase%` = scales::percent(`Chase%`, accuracy = 0.1),
             `Whiff%` = scales::percent(`Whiff%`, accuracy = 0.1),
             `Z-Whiff%` = scales::percent(`Z-Whiff%`, accuracy = 0.1),
             `Z-Swing%` = scales::percent(`Z-Swing%`, accuracy = 0.1),
             `Swing%` = scales::percent(`Swing%`, accuracy = 0.1),
             xDamage = sprintf("%.3f", xDamage),
             xwOBA = sprintf("%.3f", xwOBA),
             AvgEV = sprintf("%.1f", AvgEV),
             AVG = sprintf("%.3f", AVG),
             OBP = sprintf("%.3f", OBP),
             SLG = sprintf("%.3f", SLG)) %>% 
      select(Pitch, Pitches, `CSW%`, `Zone%`, `Chase%`, `Whiff%`, 
             `Z-Whiff%`, `Z-Swing%`, `Swing%`, xDamage, xwOBA, AvgEV, AVG, SLG)
    
    table[is.na(table)] <- "-"
    
    tableFilter <- reactive({table})
    datatable(tableFilter(), options = list(dom = 't', columnDefs = list(list(targets = 0, visible = FALSE))))
  })
  
  output$pitch_type_table <- renderDataTable({
    table <- FinalCSV
    
    if(input$PitcherInput != "All") {
      table <- table %>% filter(Pitcher %in% input$PitcherInput)
    }
    table <- table %>%
      filter(between(Date, input$DateRangeInput[1], input$DateRangeInput[2])) %>%   
      group_by('Pitch' = TaggedPitchType,
               'Side' = BatterSide) %>%
      summarize('Pitches' = n(),
                PA = sum(PACheck, na.rm = TRUE), 
                AB = sum(ABCheck, na.rm = TRUE), 
                H = sum(HCheck, na.rm = TRUE), 
                `1B` = sum(SingleCheck, na.rm = TRUE), 
                `2B` = sum(DoubleCheck, na.rm = TRUE), 
                `3B` = sum(TripleCheck, na.rm = TRUE), 
                HR = sum(HRCheck, na.rm = TRUE), 
                TB = (`1B`) + (`2B` * 2) + (`3B` * 3) + (HR * 4),
                SO = sum(StrikeoutCheck, na.rm = TRUE), 
                BB = sum(WalkCheck, na.rm = TRUE), 
                HBP = sum(HBPCheck, na.rm = TRUE),
                xwOBA = round(mean(xwOBAvalues[PACheck == TRUE], na.rm = TRUE), 3),
                `CSW%` = mean(CSWCheck, na.rm = TRUE), 
                `Strike%` = mean(StrikeCheck, na.rm = TRUE), 
                `StrikeProb%` = mean(called_strike_prob, na.rm = TRUE),
                `Zone%` = mean(ZoneCheck, na.rm = TRUE), 
                `Swing%` = mean(SwingCheck, na.rm = TRUE), 
                `Chase%` = mean(SwingCheck[ZoneCheck == FALSE], na.rm = TRUE), 
                `Z-Whiff%` = mean(WhiffCheck[ZoneCheck == TRUE & SwingCheck == TRUE]),
                `Whiff%` = mean(WhiffCheck[SwingCheck == TRUE], na.rm = TRUE), 
                `Z-Swing%` = mean(SwingCheck[ZoneCheck == TRUE], na.rm = TRUE),
                BBE = sum(BBECheck, na.rm = TRUE),
                xDamage = mean(av_xwOBAcon[BBECheck == TRUE],  na.rm = TRUE),
                AvgEV = mean(ExitSpeed[BBECheck == TRUE], na.rm = TRUE), 
                AVG = H / AB,
                OBP = (H + BB + HBP) / PA,
                SLG = TB / AB) %>% 
      mutate(`CSW%` = scales::percent(`CSW%`, accuracy = 0.1),
             `Strike%` = scales::percent(`Strike%`, accuracy = 0.1),
             `StrikeProb%` = scales::percent(`StrikeProb%`, accuracy = 0.1),
             `Zone%` = scales::percent(`Zone%`, accuracy = 0.1),
             `Chase%` = scales::percent(`Chase%`, accuracy = 0.1),
             `Whiff%` = scales::percent(`Whiff%`, accuracy = 0.1),
             `Z-Whiff%` = scales::percent(`Z-Whiff%`, accuracy = 0.1),
             `Z-Swing%` = scales::percent(`Z-Swing%`, accuracy = 0.1),
             `Swing%` = scales::percent(`Swing%`, accuracy = 0.1),
             xDamage = sprintf("%.3f", xDamage),
             xwOBA = sprintf("%.3f", xwOBA),
             AvgEV = sprintf("%.1f", AvgEV),
             AVG = sprintf("%.3f", AVG),
             OBP = sprintf("%.3f", OBP),
             SLG = sprintf("%.3f", SLG)) %>% 
      select(Pitch, Side, Pitches, `CSW%`, `Zone%`, `Chase%`, `Whiff%`, 
             `Z-Whiff%`, `Z-Swing%`, `Swing%`, xDamage, xwOBA, AvgEV, AVG, SLG)
    
    table[is.na(table)] <- "-"
    
    tableFilter <- reactive({table})
    datatable(tableFilter(), options = list(dom = 't', columnDefs = list(list(targets = 0, visible = FALSE))))
  })
  
  output$pitcher_splits_table <- renderDataTable({
    table <- FinalCSV
    
    if(input$PitcherInput != "All") {
      table <- table %>% filter(Pitcher %in% input$PitcherInput)
    }
    
    table <- table %>%
      filter(between(Date, input$DateRangeInput[1], input$DateRangeInput[2])) %>%
      group_by('Side' = BatterSide) %>%
      summarize('Pitches' = n(),
                PA = sum(PACheck, na.rm = TRUE), 
                AB = sum(ABCheck, na.rm = TRUE), 
                H = sum(HCheck, na.rm = TRUE), 
                `1B` = sum(SingleCheck, na.rm = TRUE), 
                `2B` = sum(DoubleCheck, na.rm = TRUE), 
                `3B` = sum(TripleCheck, na.rm = TRUE), 
                HR = sum(HRCheck, na.rm = TRUE), 
                TB = (`1B`) + (`2B` * 2) + (`3B` * 3) + (HR * 4),
                SO = sum(StrikeoutCheck, na.rm = TRUE), 
                BB = sum(WalkCheck, na.rm = TRUE), 
                HBP = sum(HBPCheck, na.rm = TRUE),
                xwOBA = round(mean(xwOBAvalues[PACheck == TRUE], na.rm = TRUE), 3),
                `CSW%` = mean(CSWCheck, na.rm = TRUE), 
                `Strike%` = mean(StrikeCheck, na.rm = TRUE), 
                `StrikeProb%` = mean(called_strike_prob, na.rm = TRUE),
                `Zone%` = mean(ZoneCheck, na.rm = TRUE), 
                `Swing%` = mean(SwingCheck, na.rm = TRUE), 
                `Chase%` = mean(SwingCheck[ZoneCheck == FALSE], na.rm = TRUE), 
                `Z-Whiff%` = mean(WhiffCheck[ZoneCheck == TRUE & SwingCheck == TRUE]),
                `Whiff%` = mean(WhiffCheck[SwingCheck == TRUE], na.rm = TRUE), 
                `Z-Swing%` = mean(SwingCheck[ZoneCheck == TRUE], na.rm = TRUE),
                BBE = sum(BBECheck, na.rm = TRUE),
                xDamage = mean(av_xwOBAcon[BBECheck == TRUE],  na.rm = TRUE),
                AvgEV = mean(ExitSpeed[BBECheck == TRUE], na.rm = TRUE), 
                AVG = H / AB,
                OBP = (H + BB + HBP) / PA,
                SLG = TB / AB) %>% 
      mutate(`CSW%` = scales::percent(`CSW%`, accuracy = 0.1),
             `Strike%` = scales::percent(`Strike%`, accuracy = 0.1),
             `StrikeProb%` = scales::percent(`StrikeProb%`, accuracy = 0.1),
             `Zone%` = scales::percent(`Zone%`, accuracy = 0.1),
             `Chase%` = scales::percent(`Chase%`, accuracy = 0.1),
             `Whiff%` = scales::percent(`Whiff%`, accuracy = 0.1),
             `Z-Whiff%` = scales::percent(`Z-Whiff%`, accuracy = 0.1),
             `Z-Swing%` = scales::percent(`Z-Swing%`, accuracy = 0.1),
             `Swing%` = scales::percent(`Swing%`, accuracy = 0.1),
             xDamage = sprintf("%.3f", xDamage),
             xwOBA = sprintf("%.3f", xwOBA),
             AvgEV = sprintf("%.1f", AvgEV),
             AVG = sprintf("%.3f", AVG),
             OBP = sprintf("%.3f", OBP),
             SLG = sprintf("%.3f", SLG)) %>% 
      select(Side, Pitches, `CSW%`, `Zone%`, `Chase%`, `Whiff%`, 
             `Z-Whiff%`, `Z-Swing%`, `Swing%`, xDamage, xwOBA, AvgEV, AVG, SLG)
    
    table[is.na(table)] <- "-"
    
    tableFilter <- reactive({table})
    datatable(tableFilter(), options = list(dom = 't', columnDefs = list(list(targets = 0, visible = FALSE))))
  })
  
  output$pitcher_count_results <- renderDataTable({
    table <- FinalCSV
    
    if(input$PitcherInput != "All") {
      table <- table %>% filter(Pitcher %in% input$PitcherInput)
    }
    
    table <- table %>%
      filter(between(Date, input$DateRangeInput[1], input$DateRangeInput[2])) %>%
      group_by(Count) %>%
      summarize('Pitches' = n(),
                PA = sum(PACheck, na.rm = TRUE), 
                AB = sum(ABCheck, na.rm = TRUE), 
                H = sum(HCheck, na.rm = TRUE), 
                `1B` = sum(SingleCheck, na.rm = TRUE), 
                `2B` = sum(DoubleCheck, na.rm = TRUE), 
                `3B` = sum(TripleCheck, na.rm = TRUE), 
                HR = sum(HRCheck, na.rm = TRUE), 
                TB = (`1B`) + (`2B` * 2) + (`3B` * 3) + (HR * 4),
                SO = sum(StrikeoutCheck, na.rm = TRUE), 
                BB = sum(WalkCheck, na.rm = TRUE), 
                HBP = sum(HBPCheck, na.rm = TRUE),
                xwOBA = round(mean(xwOBAvalues[PACheck == TRUE], na.rm = TRUE), 3),
                `CSW%` = mean(CSWCheck, na.rm = TRUE), 
                `Strike%` = mean(StrikeCheck, na.rm = TRUE), 
                `StrikeProb%` = mean(called_strike_prob, na.rm = TRUE),
                `Zone%` = mean(ZoneCheck, na.rm = TRUE), 
                `Swing%` = mean(SwingCheck, na.rm = TRUE), 
                `Chase%` = mean(SwingCheck[ZoneCheck == FALSE], na.rm = TRUE), 
                `Z-Whiff%` = mean(WhiffCheck[ZoneCheck == TRUE & SwingCheck == TRUE]),
                `Whiff%` = mean(WhiffCheck[SwingCheck == TRUE], na.rm = TRUE), 
                `Z-Swing%` = mean(SwingCheck[ZoneCheck == TRUE], na.rm = TRUE),
                BBE = sum(BBECheck, na.rm = TRUE),
                xDamage = mean(av_xwOBAcon[BBECheck == TRUE],  na.rm = TRUE),
                AvgEV = mean(ExitSpeed[BBECheck == TRUE], na.rm = TRUE), 
                AVG = H / AB,
                OBP = (H + BB + HBP) / PA,
                SLG = TB / AB) %>% 
      mutate(`CSW%` = scales::percent(`CSW%`, accuracy = 0.1),
             `Strike%` = scales::percent(`Strike%`, accuracy = 0.1),
             `StrikeProb%` = scales::percent(`StrikeProb%`, accuracy = 0.1),
             `Zone%` = scales::percent(`Zone%`, accuracy = 0.1),
             `Chase%` = scales::percent(`Chase%`, accuracy = 0.1),
             `Whiff%` = scales::percent(`Whiff%`, accuracy = 0.1),
             `Z-Whiff%` = scales::percent(`Z-Whiff%`, accuracy = 0.1),
             `Z-Swing%` = scales::percent(`Z-Swing%`, accuracy = 0.1),
             `Swing%` = scales::percent(`Swing%`, accuracy = 0.1),
             xDamage = sprintf("%.3f", xDamage),
             xwOBA = sprintf("%.3f", xwOBA),
             AvgEV = sprintf("%.1f", AvgEV),
             AVG = sprintf("%.3f", AVG),
             OBP = sprintf("%.3f", OBP),
             SLG = sprintf("%.3f", SLG)) %>% 
      select(Count, Pitches, `CSW%`, `Zone%`, `Chase%`, `Whiff%`, 
             `Z-Whiff%`, `Z-Swing%`, `Swing%`, xDamage, xwOBA, AvgEV, AVG, SLG)
    
    table[is.na(table)] <- "-"
    
    tableFilter <- reactive({table})
    datatable(tableFilter(), options = list(dom = 't', pageLength = nrow(tableFilter()), columnDefs = list(list(targets = 0, visible = FALSE))))
    
  })
  
  output$pitch_movement_plot <- renderPlot({
    dataFilter <- reactive({
      FinalCSV %>%
        filter(Pitcher == input$PitcherInput, 
               between(Date, input$DateRangeInput[1], input$DateRangeInput[2]))
    })
    ggplot(data = dataFilter(), aes(x = HorzBreak, y = InducedVertBreak, color = TaggedPitchType)) + 
      labs(x = "Horizontal Movement (HB)", y = "Vertical Movement (IVB)", color = "Pitch Type", title = "Pitch Movement") + 
      xlim(-30, 30) + ylim(-30, 30) +
      geom_segment(aes(x = 0, y = -25, xend = 0, yend = 25), size = 1, color = "grey55") + 
      geom_segment(aes(x = -25, y = 0, xend = 25, yend = 0), size = 1, color = "grey55") +
      geom_point(size = 3, na.rm = TRUE) +
      theme_bw() + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0.5)) +
      theme(legend.position = "bottom", legend.text = element_text(size = 12), axis.title = element_text(size = 14))
  }, width = 450, height = 400)
  
  output$umpire_analysis <- renderPlot({
    dataFilter <- reactive({
      FinalCSV %>%
        filter(Pitcher == input$PitcherInput, 
               between(Date, input$DateRangeInput[1], input$DateRangeInput[2]),
               PitchCall == "BallCalled" | PitchCall == "StrikeCalled" | PitchCall == "BallinDirt")
    })
    ggplot(data = dataFilter(), aes(x = PlateLocSide, y = PlateLocHeight, color = PitchCall)) +
      geom_point(size = 3) +
      theme_bw() +
      labs(x = "PlateLocSide", y = "PlateLocHeight",
           fill = "Called Strike Probability") +
      annotate("rect", xmin = -1, xmax = 1,
               ymin = 1.6, ymax = 3.4,
               fill= NA, color= "black", 
               alpha = .1) +
      ylim(1.2, 3.8) +
      xlim(-1.6, 1.6)
  }, width = 450, height = 450)
  
  output$pitch_release_plot <- renderPlot({
    dataFilter <- reactive({
      FinalCSV %>%
        filter(Pitcher == input$PitcherInput, 
               between(Date, input$DateRangeInput[1], input$DateRangeInput[2]))
    })
    ggplot(data = dataFilter(), aes(x = RelSide, y = RelHeight, color = TaggedPitchType)) +
      labs(x = "Horizontal Release Point", y = "Vertical Release Point", color = " ", title = "Release") + 
      xlim(-4, 4) + ylim(2, 7) +
      geom_segment(aes(x = 0, y = -25, xend = 0, yend = 25), size = 1, color = "grey55") + 
      geom_segment(aes(x = -25, y = 0, xend = 25, yend = 0), size = 1, color = "grey55") +
      geom_point(size = 3, na.rm = TRUE) +
      theme_bw() + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0.5)) +
      theme(legend.position = "bottom", legend.text = element_text(size = 12), axis.title = element_text(size = 14))
  }, width = 450, height = 400)
  
  output$pitch_location_plot1 <- renderPlot({
    dataFilter <- reactive({
      FinalCSV %>%
        filter(Pitcher == input$PitcherInput,
               between(Date, input$DateRangeInput[1], input$DateRangeInput[2]))
    }) 
    ggplot(data = dataFilter(), aes(x = PlateLocSide, y = PlateLocHeight,color = TaggedPitchType)) +
      labs(x = "Horizontal Location", y = "Vertical Location", color = " ", title = "Location (All)", subtitle = "From the Pitcher's Perspective") +  
      geom_point(size = 3)+
      annotate("rect", xmin = -1, xmax = 1,
               ymin = 1.6,ymax = 3.4,
               fill= NA,color= "black", 
               alpha = .1) +
      ylim(1, 4) + xlim(-1.8, 1.8) + theme_bw() + 
      theme_bw() + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0.5)) +
      theme(legend.position = "bottom", legend.text = element_text(size = 12), axis.title = element_text(size = 14))
  }, width = 400, height = 350)
  
  
  output$pitch_location_plot2 <- renderPlot({
    dataFilter <- reactive({
      FinalCSV %>%
        filter(Pitcher == input$PitcherInput,
               between(Date, input$DateRangeInput[1], input$DateRangeInput[2]),
               BatterSide == "Left")
    }) 
    ggplot(data = dataFilter(), aes(x = PlateLocSide, y = PlateLocHeight,color = TaggedPitchType)) +
      labs(x = "Horizontal Location", y = "Vertical Location", color = " ", title = "Location (LHB)", subtitle = "From the Pitcher's Perspective") + 
      geom_point(size = 3)+
      annotate("rect", xmin = -1, xmax = 1,
               ymin = 1.6,ymax = 3.4,
               fill= NA,color= "black", 
               alpha = .1) +
      ylim(1, 4) + xlim(-1.8, 1.8) + theme_bw() + 
      theme_bw() + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0.5)) +
      theme(legend.position = "bottom", legend.text = element_text(size = 12), axis.title = element_text(size = 14))
  }, width = 400, height = 350)
  
  output$pitch_location_plot3 <- renderPlot({
    dataFilter <- reactive({
      FinalCSV %>%
        filter(Pitcher == input$PitcherInput,
               between(Date, input$DateRangeInput[1], input$DateRangeInput[2]),
               BatterSide == "Right")
    }) 
    ggplot(data = dataFilter(), aes(x = PlateLocSide, y = PlateLocHeight,color = TaggedPitchType)) +
      labs(x = "Horizontal Location", y = "Vertical Location", color = " ", title = "Location (RHB)", subtitle = "From the Pitcher's Perspective") + 
      geom_point(size = 3)+
      annotate("rect", xmin = -1, xmax = 1,
               ymin = 1.6,ymax = 3.4,
               fill= NA,color= "black", 
               alpha = .1) +
      ylim(1, 4) + xlim(-1.8, 1.8) + theme_bw() + 
      theme_bw() + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0.5)) +
      theme(legend.position = "bottom", legend.text = element_text(size = 12), axis.title = element_text(size = 14))
  }, width = 400, height = 350)
  
  output$lineplot1 <- renderPlot({
    dataFilter <- reactive({
      FinalCSV %>%
        filter(Pitcher == input$PitcherInput,
               between(Date, input$DateRangeInput[1], input$DateRangeInput[2])) %>% 
        mutate(PitchNo = row_number())
    })
    ggplot(dataFilter(), aes(x = PitchNo, y = InducedVertBreak, color = TaggedPitchType)) + 
      geom_line(size = 2) +
      labs(x = "Pitch Count", y = "Induced Vertical Break", title = "IVB Over Time", color = "") +
      ylim(-20, 30) + 
      theme_bw() + theme(legend.position = "none", plot.title = element_text(hjust = 0.5, face = "bold", size = 16)) +
      theme(axis.title = element_text(size = 14), axis.text = element_text(size = 12))
  }, width = 900, height = 400)
  
  output$lineplot2 <- renderPlot({
    dataFilter <- reactive({
      FinalCSV %>%
        filter(Pitcher == input$PitcherInput,
               between(Date, input$DateRangeInput[1], input$DateRangeInput[2])) %>%
        mutate(PitchNo = row_number())
    })
    ggplot(data = dataFilter()) + 
      geom_line(aes(y = RelSpeed, x = PitchNo, color = TaggedPitchType), size = 2) + 
      labs(x = "Pitch Count", y = "Pitch Velocity (MPH)", color = " ", title = "Pitch Velocity") + 
      ylim(65, 95) + 
      theme_bw() + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0.5), axis.text = element_text(size = 12)) +
      theme(legend.position = "none", legend.text = element_text(size = 12), axis.title = element_text(size = 14))
  }, width = 900, height = 400)
  
  output$lineplot3 <- renderPlot({
    dataFilter <- reactive({
      FinalCSV %>%
        filter(Pitcher == input$PitcherInput,
               between(Date, input$DateRangeInput[1], input$DateRangeInput[2])) %>% 
        mutate(PitchNo = row_number())
    })
    ggplot(dataFilter(), aes(x = PitchNo, y = HorzBreak, color = TaggedPitchType)) + 
      geom_line(size = 2) +
      labs(x = "Pitch Count", y = "Horizontal Break", title = "HB Over Time", color = "") +
      ylim(-25, 25) + 
      theme_bw() + theme(legend.position = "none", plot.title = element_text(hjust = 0.5, face = "bold", size = 16)) +
      theme(axis.title = element_text(size = 14), axis.text = element_text(size = 12))
  }, width = 900, height = 400)
  
  output$lineplot4 <- renderPlot({
    dataFilter <- reactive({
      FinalCSV %>%
        filter(Pitcher == input$PitcherInput,
               between(Date, input$DateRangeInput[1], input$DateRangeInput[2])) %>% 
        mutate(PitchNo = row_number())
    })
    ggplot(dataFilter(), aes(x = PitchNo, y = SpinRate, color = TaggedPitchType)) + 
      geom_line(size = 2) +
      labs(x = "Pitch Count", y = "Spin Rate", title = "Spin Rate Over Time", color = "") +
      ylim(1000, 3500) + 
      theme_bw() + theme(legend.position = "none", plot.title = element_text(hjust = 0.5, face = "bold", size = 16)) +
      theme(axis.title = element_text(size = 14), axis.text = element_text(size = 12))
  }, width = 900, height = 400)
  
  output$lineplot5 <- renderPlot({
    dataFilter <- reactive({
      FinalCSV %>%
        filter(Pitcher == input$PitcherInput,
               between(Date, input$DateRangeInput[1], input$DateRangeInput[2])) %>% 
        mutate(PitchNo = row_number())
    })
    ggplot(dataFilter(), aes(x = PitchNo, y = Stuff_plus, color = TaggedPitchType)) + 
      geom_line(size = 2) +
      labs(x = "Pitch Count", y = "Stuff", title = "Stuff Over Time", color = "") +
      ylim(50, 150) + 
      theme_bw() + theme(legend.position = "none", plot.title = element_text(hjust = 0.5, face = "bold", size = 16)) +
      theme(axis.title = element_text(size = 14), axis.text = element_text(size = 12)) + 
      theme(legend.position = "top", legend.text = element_text(size = 12), axis.title = element_text(size = 14))
  }, width = 900, height = 400)
  
  output$plot1 <- renderPlot({
    dataFilter <- reactive({
      FinalCSV %>%
        filter(Pitcher == input$PitcherInput,
               between(Date, input$DateRangeInput[1], input$DateRangeInput[2]))
    })
    ggplot(dataFilter(), aes(x = PlateLocSide, y = PlateLocHeight)) +
      stat_density_2d(aes(fill = ..density..), geom = 'raster', contour = F) +
      scale_fill_gradientn(colours = c("blue", "white", "red")) +
      annotate("rect", xmin = -1, xmax = 1,
               ymin = 1.6,ymax = 3.4,
               fill= NA,color= "black", 
               alpha = .1) +
      ylim(1, 4) + xlim(-1.8, 1.8) + theme_bw() + 
      theme_classic() +
      xlab("Horizontal Pitch Location") +
      ylab("Vertical Pitch Location") +
      ggtitle("Pitch Location Heat Map", subtitle = "Pitcher's Perspective") +
      facet_wrap(~TaggedPitchType, ncol = 3) +
      guides(fill = FALSE)
  }, width = 700, height = 400)
  
  output$plot2 <- renderPlot({
    dataFilter <- reactive({
      FinalCSV %>%
        filter(Pitcher == input$PitcherInput,
               between(Date, input$DateRangeInput[1], input$DateRangeInput[2]))
    })
    
    
    ggplot(dataFilter(), aes(x = HorzBreak, y = InducedVertBreak)) +
      geom_point(aes(color=PitchGroup, size = 3, alpha = Stuff_plus)) +
      scale_fill_gradient2(midpoint = mean(Stuff_plus), low = "blue", high = "red") +
      coord_fixed(ratio = 1, xlim = c(-30, 30), ylim = c(-20, 30)) +
      geom_hline(yintercept = 0) + 
      geom_vline(xintercept = 0) +
      theme_bw() +
      xlab("Horizontal Pitch Location") +
      ylab("Vertical Pitch Location") +
      ggtitle("Stuff+ Heat Map", subtitle = "Pitcher's Perspective") +
      facet_wrap(~PitchGroup, ncol = 2)
  }, width = 700, height = 400)
  
  

  
  output$r_fb_stuff_plot <- renderPlot({
    
    dataFilter <- reactive({
      FinalCSV %>%
        filter(Pitcher == input$PitcherInput,
               between(Date, input$DateRangeInput[1], input$DateRangeInput[2]),
               PitchGroup == 'FB',
               PitcherThrows == 'Right')
    })
    
    dataFilter2 <- reactive({
      r_fb_all_predictions %>%
        filter(RelSpeed >= (round(mean(dataFilter()$RelSpeed),0) - 2) & RelSpeed <= (round(mean(dataFilter()$RelSpeed),0) + 2))
    })
    
    
    base_plot <- ggplot() +
      geom_tile(data = dataFilter2(), aes(x = HorzBreak, y = InducedVertBreak, fill = Stuff_plus, alpha = -Stuff_plus)) +
      scale_fill_gradient2(midpoint = mean(dataFilter2()$Stuff_plus), low = "blue", high = "red") +
      geom_hline(yintercept = 0) + 
      geom_vline(xintercept = 0) +
      theme_classic() +
      xlab("Horizontal Pitch Location") +
      ylab("Vertical Pitch Location") +
      ggtitle("Righty Fastball Stuff+ Heat Map", subtitle = "Pitcher's Perspective") +
      guides(alpha=FALSE, size=FALSE)
    
    final_plot <- base_plot +
      geom_point(aes(x = dataFilter()$HorzBreak, y = dataFilter()$InducedVertBreak), color = "black", alpha=0.2, size=2)
      
    print(final_plot)
    
  }, width = 700, height = 400)
  
  output$r_os_stuff_plot <- renderPlot({
    
    dataFilter <- reactive({
      FinalCSV %>%
        filter(Pitcher == input$PitcherInput,
               between(Date, input$DateRangeInput[1], input$DateRangeInput[2]),
               PitchGroup == 'OS',
               PitcherThrows == 'Right')
    })
    
    dataFilter2 <- reactive({
      r_os_all_predictions %>%
        filter(RelSpeed >= (round(mean(dataFilter()$RelSpeed),0) - 2) & RelSpeed <= (round(mean(dataFilter()$RelSpeed),0) + 2))
    })
    
    
    base_plot <- ggplot() +
      geom_tile(data = dataFilter2(), aes(x = HorzBreak, y = InducedVertBreak, fill = Stuff_plus, alpha = -Stuff_plus)) +
      scale_fill_gradient2(midpoint = mean(dataFilter2()$Stuff_plus), low = "blue", high = "red") +
      geom_hline(yintercept = 0) + 
      geom_vline(xintercept = 0) +
      theme_classic() +
      xlab("Horizontal Pitch Location") +
      ylab("Vertical Pitch Location") +
      ggtitle("Righty OffSpeed Stuff+ Heat Map", subtitle = "Pitcher's Perspective") +
      guides(alpha=FALSE, size=FALSE)
    
    final_plot <- base_plot +
      geom_point(aes(x = dataFilter()$HorzBreak, y = dataFilter()$InducedVertBreak), color = "black", alpha=0.2, size=2)
    
    print(final_plot)
    
  }, width = 700, height = 400)
  
  output$l_fb_stuff_plot <- renderPlot({
    
    dataFilter <- reactive({
      FinalCSV %>%
        filter(Pitcher == input$PitcherInput,
               between(Date, input$DateRangeInput[1], input$DateRangeInput[2]),
               PitchGroup == 'FB',
               PitcherThrows == 'Left')
    })
    
    dataFilter2 <- reactive({
      l_fb_all_predictions %>%
        filter(RelSpeed >= (round(mean(dataFilter()$RelSpeed),0) - 2) & RelSpeed <= (round(mean(dataFilter()$RelSpeed),0) + 2))
    })
    
    
    base_plot <- ggplot() +
      geom_tile(data = dataFilter2(), aes(x = HorzBreak, y = InducedVertBreak, fill = Stuff_plus, alpha = -Stuff_plus)) +
      scale_fill_gradient2(midpoint = mean(dataFilter2()$Stuff_plus), low = "blue", high = "red") +
      geom_hline(yintercept = 0) + 
      geom_vline(xintercept = 0) +
      theme_classic() +
      xlab("Horizontal Pitch Location") +
      ylab("Vertical Pitch Location") +
      ggtitle("Lefty Fastball Stuff+ Heat Map", subtitle = "Pitcher's Perspective") +
      guides(alpha=FALSE, size=FALSE)
    
    final_plot <- base_plot +
      geom_point(aes(x = dataFilter()$HorzBreak, y = dataFilter()$InducedVertBreak), color = "black", alpha=0.2, size=2)
    
    print(final_plot)
    
  }, width = 700, height = 400)
  
  output$l_os_stuff_plot <- renderPlot({
    
    dataFilter <- reactive({
      FinalCSV %>%
        filter(Pitcher == input$PitcherInput,
               between(Date, input$DateRangeInput[1], input$DateRangeInput[2]),
               PitchGroup == 'OS',
               PitcherThrows == 'Left')
    })
    
    dataFilter2 <- reactive({
      l_os_all_predictions %>%
        filter(RelSpeed >= (round(mean(dataFilter()$RelSpeed),0) - 2) & RelSpeed <= (round(mean(dataFilter()$RelSpeed),0) + 2))
    })
    
    
    base_plot <- ggplot() +
      geom_tile(data = dataFilter2(), aes(x = HorzBreak, y = InducedVertBreak, fill = Stuff_plus, alpha = -Stuff_plus)) +
      scale_fill_gradient2(midpoint = mean(dataFilter2()$Stuff_plus), low = "blue", high = "red") +
      geom_hline(yintercept = 0) + 
      geom_vline(xintercept = 0) +
      theme_classic() +
      xlab("Horizontal Pitch Location") +
      ylab("Vertical Pitch Location") +
      ggtitle("Lefty OffSpeed Stuff+ Heat Map", subtitle = "Pitcher's Perspective") +
      guides(alpha=FALSE, size=FALSE)
    
    final_plot <- base_plot +
      geom_point(aes(x = dataFilter()$HorzBreak, y = dataFilter()$InducedVertBreak), color = "black", alpha=0.2, size=2)
    
    print(final_plot)
    
  }, width = 700, height = 400)
  
  output$pitcher_summary_table_plus_2 <- renderDataTable({
    table <- FinalCSV_plus_two
    
    if(input$PitcherInput != "All") {
      table <- table %>% filter(Pitcher %in% input$PitcherInput)
    }
    table <- table %>%
      filter(between(Date, input$DateRangeInput[1], input$DateRangeInput[2])) %>%
      group_by('Pitch' = TaggedPitchType) %>%
      summarize('Pitches' = n(), 
                'Stuff' = round(median(Stuff_plus, na.rm = TRUE), 0), 
                'AvgVelo' = round(median(RelSpeed, na.rm = TRUE), 1),
                'MaxVelo' = round(max(RelSpeed, na.rm = TRUE), 1),
                'SpinRate' = round(median(SpinRate, na.rm = TRUE), 0),
                'IVB' = round(median(InducedVertBreak, na.rm = TRUE), 1),
                'HB' = round(median(HorzBreak, na.rm = TRUE), 1),
                'RelZ' = round(median(RelHeight, na.rm = TRUE), 1),
                'RelX' = round(median(RelSide, na.rm = TRUE), 1),
                'Ext' = round(median(Extension, na.rm = TRUE), 1)) %>% 
      mutate(Usage = Pitches / sum(Pitches)) %>% 
      mutate(Usage = scales::percent(Usage, accuracy = 0.1)) %>%
      select(Pitch, Pitches, Stuff, Usage, AvgVelo, MaxVelo, SpinRate, IVB, HB, RelZ, RelX, Ext)
    
    table[is.na(table)] = 0  
    
    tableFilter <- reactive({table})
    datatable(tableFilter(), options = list(dom = 't', columnDefs = list(list(targets = 0, visible = FALSE))))
  })
  
}

shinyApp(ui = ui, server = server)


#deployApp() in console to push to website
